Bootstrap: localimage
From: {{CONTAINERDIR}}/ubuntu22.04_turbovnc.sif

%arguments
	CONTAINERDIR=../
	FREESURFER_VERSION=7.4.1
	FREESURFER_ARCH=amd64


%help
	This is an Apptainer container of Ubuntu 22.04 with TurboVNC and FreeSurfer installed.

%labels
	MAINTAINER "Altan Orhon - altan@uw.edu"

%setup 
	f=./"freesurfer_ubuntu22-{{FREESURFER_VERSION}}_{{FREESURFER_ARCH}}.deb"
	if [ -r "$f" ]; then
		echo "Using pre-downloaded freesurfer binary package!"
		cp "$f" "${APPTAINER_ROOTFS}/freesurfer.deb"
	else
		echo "Did not find pre-downloaded freesurfer binary package at location ${f:-}"
	fi

%environment
	export FREESURFER_VERSION="{{FREESURFER_VERSION}}"
	export FREESURFER_HOME="/usr/local/freesurfer/${FREESURFER_VERSION}"

%post
	set -x
	export DEBIAN_FRONTEND=noninteractive
	export LC_ALL='C.UTF-8'
	export LANG='C.UTF-8'
	FREESURFER_VERSION="{{FREESURFER_VERSION}}"
	export FREESURFER_HOME="/usr/local/freesurfer/${FREESURFER_VERSION}"

	# Download freesurfer binary package if not exists:
	if [ ! -r /freesurfer.deb ]; then
		echo "Not using pre-downloaded freesurfer binary package!"
		echo "Downloading freesurfer binary package..."
		FREESURFER_DL_URL=https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/${FREESURFER_VERSION}/freesurfer_ubuntu22-${FREESURFER_VERSION}_amd64.deb
		curl -L -o /freesurfer.deb "${FREESURFER_DL_URL}" || exit 1
	fi

	# Update apt:
	apt-get update --yes --quiet

	# Install dependencies for freesurfer:
	apt-get install --yes --quiet --no-install-recommends \
	
	# Install freesurfer:
	dpkg --install /freesurfer.deb

	# Fix dependencies:
	apt-get --fix-broken install --yes --quiet --no-install-recommends

	# Clean up freesurfer binary package:
	rm /freesurfer.deb

	# Clean up packages:
	apt-get clean --yes --quiet && rm -rf /var/lib/apt/lists/*
