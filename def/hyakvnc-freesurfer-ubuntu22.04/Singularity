Bootstrap: docker
From: ubuntu:22.04

%arguments
	FREESURFER_VERSION=7.4.1
	RECON_ALL_CLINICAL_HASH=ecdf46e
	RECON_ALL_CLINICAL_URL=https://raw.githubusercontent.com/freesurfer/freesurfer/{{RECON_ALL_CLINICAL_HASH}}/recon_all_clinical/recon-all-clinical.sh
  MCR_VERSION=R2014b
  # SETUP_DOWNLOADS_MOUNT [optional] [default: "/opt/.setup-downloads"] The path to the directory where the setup files will be downloaded. This directory should be mounted as a volume in the container.
  SETUP_DOWNLOADS_MOUNT=/opt/.setup-downloads

%help
This is an Apptainer container of Ubuntu 22.04 with FreeSurfer installed. It is designed to be run on the Hyak cluster at the University of Washington with the hyakvnc script.

%setup
	../../bin/write-apptainer-labels.sh > "${APPTAINER_ROOTFS}/.build_labels"
  [ -n "${SETUP_DOWNLOADS_MOUNT:-{{SETUP_DOWNLOADS_MOUNT}}}" ] && export SETUP_DOWNLOADS_MOUNT="${SETUP_DOWNLOADS_MOUNT:-{{SETUP_DOWNLOADS_MOUNT}}}" && mkdir -p "${APPTAINER_ROOTFS}/${SETUP_DOWNLOADS_MOUNT}"

%labels
	edu.uw.hyakvnc.container.resources.recommends.mem 16G
	edu.uw.hyakvnc.container.resources.requires.mem 8G
	edu.uw.hyakvnc.container.resources.recommends.cpus 4
	edu.uw.hyakvnc.container.resources.requires.cpus 1
	edu.uw.hyakvnc.container.resources.suggests.gpus 1
	
%files
  ../../common /opt/setup
	../../common/configs/freesurfer/start-freeview.sh /usr/local/bin/start-freeview
	../../common/configs/freesurfer/freeview.desktop /usr/share/applications/freeview.desktop

%post
	set -x
  export DEBIAN_FRONTEND=noninteractive
  export DOWNLOAD_DIR="${DOWNLOAD_DIR:-${SETUP_DOWNLOADS_MOUNT:-/opt/.setup-downloads}}" && mkdir -p "${DOWNLOAD_DIR}" && ls -la "${DOWNLOAD_DIR}"

  apt-get update -y -qq

  # Install Ubuntu packages:
  /opt/setup/scripts/install-hyakvnc-ubuntu22.04.sh || { echo "ERROR: install-hyakvnc-ubuntu22.04.sh failed!" >&2; exit 1; }

  # Install FreeSurfer:
  /opt/setup/scripts/install-freesurfer.sh || { echo "ERROR: install-freesurfer.sh failed!" >&2; exit 1; }

	# Link /usr/local/freesurfer/dev to /usr/local/freesurfer/{{FREESURFER_VERSION}}:
	# (fixes some scripts that expect this)
	ln -s "/usr/local/freesurfer/{{FREESURFER_VERSION}}" /usr/local/freesurfer/dev

	# Patch recon-all-clinical.sh to fix a bug with FREESURFER_HOME location:
	[ -n "{{RECON_ALL_CLINICAL_URL}}" ] && curl --fail --fail-early --compressed --location \
		--output /usr/local/freesurfer/{{FREESURFER_VERSION}}/bin/recon-all-clinical.sh \
		"{{RECON_ALL_CLINICAL_URL}}" || { echo "warning: curl failed!" >&2; exit 1; }
	chmod a+x /usr/local/freesurfer/{{FREESURFER_VERSION}}/bin/recon-all-clinical.sh


  export FREESURFER_HOME="/usr/local/freesurfer/{{FREESURFER_VERSION}}"

  [ -d "${FREESURFER_HOME}" ] || { echo "ERROR: FREESURFER_HOME directory not found!" >&2; exit 1; }

  # Set up the environment by sourcing the FreeSurfer setup script, filtering out the environment variables that are already set in the container, and writing the remaining environment variables to the /.singularity.d/env directory:
    printenv | grep -oE '.*='  | tr -d '=' | sort | uniq  > /tmp/current_env_names.txt
    bash -c "source "${FREESURFER_HOME}/SetUpFreeSurfer.sh" && printenv"  > /tmp/freesurfer_env.txt
    grep -oE '.*='  /tmp/freesurfer_env.txt | tr -d '=' | sort | uniq > /tmp/freesurfer_env_names.txt
    unique_freesurfer_env_names="$(comm -13 /tmp/current_env_names.txt /tmp/freesurfer_env_names.txt | paste -s -d'|' || true)"
    
    echo "export FREESURFER_HOME=\"${FREESURFER_HOME}\"" >> /.singularity.d/env/101-hyakvnc-freesurfer-env.sh
    grep -E "^($unique_freesurfer_env_names)=" /tmp/freesurfer_env.txt | sed 's/^/export /g'  >> /.singularity.d/env/101-hyakvnc-freesurfer-env.sh

    freesurfer_path="$(grep -oE '^PATH=.*' /tmp/freesurfer_env.txt | sed 's/^PATH=//; s/:/\n/g' | cat -n | sort -uk2 | sort -n | cut -f2- | grep -F "${FREESURFER_HOME}" | paste -s -d':' || true)"
    [ -n "$freesurfer_path" ] && echo "export PATH=\"${freesurfer_path}:\${PATH}\"" >> /.singularity.d/env/101-hyakvnc-freesurfer-env.sh

  # Show the contents of the environment file:
    [ -f "/singularity.d/env/101-hyakvnc-freesurfer-env.sh" ] && echo >&2 "/singularity.d/env/101-hyakvnc-freesurfer-env.sh contents:" && cat "/singularity.d/env/101-hyakvnc-freesurfer-env.sh" >&2
  
	# Install Matlab Compiler Runtime (MCR) if requested:
  if [ -n "{{MCR_VERSION}}" ]; then
    # Install MCR dependencies:
    apt-get install -y libxt-dev libxext-dev libncurses5
    
		# Set the environment variables for fs_install_mcr to work:
		export PATH="${FREESURFER_HOME}/bin:${PATH}"

    # Install MCR:
    fs_install_mcr "{{MCR_VERSION}}"
  fi

	# Erase the setup files:
	rm -rf /opt/setup

	# Clean up packages:
	apt-get clean -y -qq && apt-get -y autoremove && rm -rf /var/lib/apt/lists/*

%environment
	export SHELL="${SHELL:-/bin/bash}"

%runscript
  hyakvnc-vncserver "$@"

%startscript
  hyakvnc-vncserver "$@"

%apprun vncserver
  hyakvnc-vncserver "$@"

%appstart vncserver
  hyakvnc-vncserver "$@"
